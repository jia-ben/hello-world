# C语言编程规范

## 目录

- [C语言编程规范](#c语言编程规范)
  - [目录](#目录)
- [排版](#排版)
  - [空行](#空行)
  - [代码行](#代码行)
  - [代码行内空格](#代码行内空格)
  - [对其缩进](#对其缩进)
  - [长行拆分](#长行拆分)
- [注释](#注释)
  - [通用规则](#通用规则)
  - [文件注释](#文件注释)
  - [函数注释](#函数注释)
  - [数据注释](#数据注释)
  - [代码注释](#代码注释)
- [命名](#命名)
  - [通用规则](#通用规则-1)
  - [文件命名](#文件命名)
  - [类型命名](#类型命名)
  - [变量命名](#变量命名)
  - [常量命名](#常量命名)
  - [函数命名](#函数命名)
  - [枚举命名](#枚举命名)
  - [宏命名](#宏命名)
- [函数](#函数)
- [文件](#文件)
- [注释](#注释-1)

本规范的内容包括：排版、注释、命名、函数、文件等。

***

# 排版

## 空行

-   在每个函数、结构体、枚举定义结束之后都要加空行。
-   在一个函数体内，逻辑密切相关的语句之间不加空行，其它地方应加空行分隔。
-   相对独立的程序块之间、变量说明之后必须加空行。

## 代码行

-   一行代码只做一件事情，如只定义一个变量，或只写一条语句。
-   if、for、do、while、case、switch、default等语句自占一行，执行语句不得紧跟其后。且if、for、do、while等语句的执行语句部分无论多少都要加括号{}。

## 代码行内空格

- 关键字之后要留空格[^注释1]。
- 函数名之后不要留空格，紧跟左括号‘(’，以与关键字区别。
- ‘,’之后要留空格，如Function(x, y, z)。如果‘;’不是一行的结束符号，其后要留空格，如for (initialization; condition; update)。
- 赋值操作符、比较操作符、算术操作符、逻辑操作符、位域操作符，如“=”、“+=” “>=”、“<=”、“+”、“ \*”、“%”、“&&”、“||”、“<<”,“^”等二元操作符的前后应当加一个空格。
- 一元操作符如“!”、“\~”、“++”、“--”、“&”（地址运算符）等前后不加空格。
- “［］”、“.”、“->”这类操作符前后不加空格。
- 对于表达式比较长的for语句和if语句，为了紧凑起见可以适当地去掉一些空格，如for (i=0; i<10; i++)和if ((a<=b) && (c<=d))

## 对其缩进

- 对齐只使用**空格键**，不能使用TAB键[^注释2]。
- 函数或过程的开始、结构的定义及循环、判断等语句中的代码都要采用缩进风格，case语句下的情况处理语句也要遵从语句缩进要求。
- 程序块的**分界符**（如‘{’和‘}’）应各**独占一行**并且位于**同一列**，同时与引用它们的语句左对齐。[^注释3]
- 预处理指令不需要缩进，总是从**行首**开始。即使预处理指令位于缩进代码块中，指令也应从**行首**开始。

## 长行拆分

- 代码行最大长度宜控制在**80个字符**以内。
- 较长的语句（>80字符）要分成多行书写；长表达式要在**低优先级**操作符处拆分成新行，操作符放在新行之首（以便突出操作符）[^注释4]。
- 循环、判断等语句中若有较长的表达式或语句，则要进行适应的**划分**. 长表达式要在低优先级操作符处划分新行，**操作符放在新行之首**。
-   若函数或过程中的**参数**较长，则要进行适当的**划分**。

# 注释

## 通用规则

- 必须保证关键的函数、流程、类型定义、变量等有相应注释说明。
- 避免在注释中使用缩写，特别是不常用的缩写。[^注释5]
- 通过对函数或过程、变量、结构等**正确的命名**以及合理地组织代码的结构，使代码成为**自注释**的。

注释格式尽量统一。[^注释6]

## 文件注释

- 源文件（包含.asm源文件、.c源文件及各种脚本文件等）头部应进行注释，应列出：版权说明、文件名、文件目的/功能，作者、创建日期等。[^注释7]
[文件注释规范](文件注释规范.md)

## 函数注释

- 函数头部进行注释，需要列出函数的功能、参数、返回值等。各项说明必须对齐。
>/******************************************************************************
** Function name:     填写本函数名称
** Descriptions:      填写本函数的主要内容或主要作用
** input parameters:  输入参数
** output parameters: 输出参数
** Returned value:    本函数的返回值
** Created by:        创建本函数的作者姓名
** Created Date:      创建本函数的日期(YYYY-MM-DD)
**-----------------------------------------------------------------------------
** Modified by:       修改本函数的程序员姓名 
** Modified date:     修改本函数的日期(YYYY-MM-DD)
**-----------------------------------------------------------------------------
******************************************************************************/

- 如果代码不需要由多个程序员进行维护，则可以简略.
>/ ******************************************************************************
** Function name:     adcGetLimitFreqency
** Descriptions:      取得ADC转换器极限频率:最高及最低转换频率
** input parameters:  ucChannel:ADC通道号
** output parameters: dwMax:ADC转换频率最高值
**                    dwMin:ADC 转换频率最低值
** Returned value:    TRUE:成功;FALSE:失败
******************************************************************************/

## 数据注释

- 对于所有有**物理含义**的变量、常量，如果其命名不是充分自注释的，在声明时都必须加以注释，说明其**物理含义**。变量、常量、宏的注释应放在其**上方相邻位置**或**右方**。
- 数据结构声明(包括结构体、枚举、类等)，如果其命名不是充分自注释的，必须加以注释。对**数据结构**的注释应放在其**上方**相邻位置；对结构中**每个域**的注释放在该域的**右方**。
- 全局变量必须有注释，最好包括对其功能、取值、及其他注意事项等的说明。

## 代码注释

- 边写代码边注释，修改代码同时修改相应的注释，以保证**注释与代码的一致性**。不再有用的注释要删除！
- 在代码的功能、意图层次上进行注释，提供有用、额外的信息。
- 如果注释放在上方，则将注释与其上面的代码用**空行隔开**。
- 对于switch语句下的case语句，如果因为**特殊情况**需要处理完**一个case后进入下一个case**处理，必须在该case语句处理完、下一个case语句前加上明确的**注释**。
- **注释**与所**描述内容**进行同样的**缩排**。
- 对那些临时的, 短期的解决方案, 或已经够好但仍不完美的代码使用 TODO 注释[^注释8]。

# 命名

## 通用规则

- 命名**直观**且**可以拼读**
- 命名应具有**描述性**。一般-类型和变量是*名词*，函数命名采用“**主+动**”。
  
  > char g_u8Counter;  //计数器——名词
  >
  > //文件打开
  > FileOpen();

- 命名使用完整英文单词或可以理解的缩写.
  
  >//良好命名
  >int g_i16NumError;

- 所有命名如果是**大小写混合**的，单词之间**不加**下划线(除了前缀)。*如果全部是大写或者全部是小写的，单词之间用下划线相连*


## 文件命名

- 文件的命名也应达到见名知意，能够反映该文件所包含的内容。
- 定义文件名时.c和.h一般成对出现，例如*stm8s_uart1.c* 和 *stm8s_uart1.h*。
- 文件名全部**小写**；为避免由于文件名过长造成难以理解，可以在适当位置使用**下划线**进行分隔。

  >良好的文件命名：
  starlib_nv.h 
  mmi_applet_table.h 
  mmicc_speeddial.c

## 类型命名

- **结构体**（struct）类型名遵循如下规则：
  >单词全部字母大写，单词间使用下划线相连。
struct的typedef类型定义名遵循如下规则：和struct名采用相同命名，但全部字母大写，单词间使用下划线相连，并以**_T**后缀结束。
  typedef struct CANMD_REG  //采取全部大写
{
…    
} CANMD_REG_T;

- **枚举**（enum）类型名遵循如下规则：
  >单词全部字母大写，单词间使用下划线相连。
enum的typedef类型定义名遵循如下规则：和enum名采用相同命名，并以**_E**后缀结束。
  >typedef enum STAR_TEL_TYPE
{
…	
}STAR_TEL_TYPE_E;

- **函数指针**（pointer to function）的typdef名遵循如下规则：
  >单词全部字母大写，单词间使用下划线相连，以**_PFUNC**后缀结束。

  >typedef void (*AUDIO_NOTIFY_CALLBACK_PFUNC)(
HAUDIO Audio, 
uint32 NotifyInfo, 
uint32 AffixInfo
);

## 变量命名

- 变量名的长度，最佳的变量名长度应该在**8到16个字符**之间，当变量名太短时，需要花费大量的时间来判断变量的含义。**单字符**的变量只能用于 *循环变量或者数组下标* 。
- 变量命名应遵循 *匈牙利* 记法，变量名由三部分组成，即：**作用域前缀 + 类型 + 描述**。
  - （1）作用域：该变量的作用范围，确定该变量的有效范围是在函数体外还是函数体内，是全局变量还是局部变量。
  - （2）类型：该变量的类型，使用小写字符。例如：整形，字符型，单精度浮点型等等，还包括自定义的结构体类型。
  - （3）描述：要完全、准确地描述出该变量所代表的事物，例如：Max、Error、New等等。

- 静态全局变量使用s_前缀，普通全局变量使用g_前缀，临时变量不加前缀。


- **基本类型**

简写	|类型	    |说明	  |示例|
---|---|---|---|
b	|bool	    |布尔型	  |bool bVal;    
u8	|unsigned char	  |无符号8位整形	|Char u8Val;
i8	|signed   char	|有符号8位整形	
u16	|unsigned int	|无符号16位整形	
i16	|signed   int	|有符号16位整形	
u16	|unsigned  short	|无符号16位整形	
i16	|signed   short	|有符号16位整形	
u32	|unsigned  long	|无符号32位整形	
i32	|signed    long	|有符号32位整形	
f32	|float	  |单精度浮点（32位）	
f64	|Double	  |双精度浮点（64位）	
p	|pointer	  |指针	|void* pUnknown; LPCTSTR pSzKey
e	|Enum	  |枚举	|enum EFileType eFileType
u	|Union	  |联合	|union UResval uVal
t	|Struct	  |一般的结构体	
str	|String	  |字符串	

>注意：
（1）struct/union中的成员变量不加前缀，即：类型 + 描述
struct STreeData
{
HICON   hTreeIcon;
TCHAR  szTreeName;
}；
（3）函数的参数变量不加前缀和类型
Void GetInfo(u8 Count，u8 Input);

- 局部变量、全局变量、参数变量、成员变量，描述采用大小写混合的方式，每个单词的第一个字母大写，其它小写。
- 对于变量命名，禁止使用单个字符（如i、j、k等）。i、j、k等仅能用作局部循环变量。

## 常量命名

- 常量名全部字母大写，单词间使用下划线相连。

## 函数命名

- **函数**命名由两部分组成：**前缀** + **描述**。
  >无返回值时加前缀v,有返回值时加r.
函数的全名示例：vTaskCreate()//无返回值
rRecInfoGet () //有返回值
- 函数名描述使用**大小写混合**，函数名中每个**单词首字母大写**。
- 函数的命名采用“主+动”形式。^[注释9]
  >（1）函数名以主语开始，这个部分一般说明函数操作的对象，即函数是为处理什么对象而编写的。例如：task、timer、motor等等。
（2）函数名的第二部分是动词，一般描述对象的行为，即函数是为对象做什么服务的。例如：On,Off,Run,Stop,Init, Open, Create, Get, Set, Read, Load, Write, Start,Stop,Check,Test,Fill,Process,Sort,Do,Select,Exist,Modify,Access。
示例：TaskCreate()、TimerInit()、MotorOn()、LedOff()。

## 枚举命名

- 枚举值全部大写，单词间使用下划线相连；枚举类型定义参见[枚举命名](#类型命名)。

## 宏命名

- 涉及物理状态或者含有物理意义的常量，不应直接使用数字，必须用有意义的宏或者枚举来代替。宏命名全部大写，单词间使用下划线相连。
  >#define STAR_DM_DES_NUM_MAX_LEN			(20)	  //DM短信目的地址最大长度
  >#define STAR_REAL_LCD_CONTRAST_DEFAULT		(4)   //液晶默认对比度

- 在定义类似**函数的宏**时，可参照函数或变量的命名规范，在前面加**小写字母m**。例如mDelay1us()、mDcdcOff()等。
- 宏定义表达式时，要注意完备的**括号**。
  >良好命名：
  >#define mAREA(dL, dH)  ((dL) * (dH))

- 将宏所定义的多条表达式放在大括号中。

# 函数

- 编写**简短**函数。
  <details> 
    <summary>说明</summary>
    <code>长函数有时是恰当的，因此对于函数长度并没有严格限制。如果函数超过 40 行，可以考虑在不影响程序结构的情况下将其分割一下。  
    >即使一个长函数现在工作的非常好，一旦有人对其修改，就有可能出现新的问题，甚至导致难以发现的bug。使函数尽量短小、简单，便于他人阅读和修改代码。  
    >在处理代码时，你可能会发现复杂的长函数，不要害怕修改现有代码：如果证实这些代码使用、调试困难，或者你需要使用其中的一小块，考虑将其分割为更加短小、易于管理的若干函数。
    </code>
  </details>
- **重复且独立性较强**的代码应抽取成函数，**功能不明确且较小**的函数，特别是仅有一个上级函数调用它时，应考虑把它合并到上级函数中，而不必单独存在。
- 提高函数**独立性**，降低函数间的耦合度，一个函数应该只实现一个功能。
- 函数**返回值**范围应充分考虑，并作全面处理。
- 除非为某些算法或功能的实现方便，应**减少**没必要的**递归调用**。
- 仔细分析模块的功能及性能需求，并进一步细分，同时若有必要画出有关**数据流图**，据此来进行程序的函数划分与组织。
  <details>
  <summary>说明</summary>
  <code>
  函数的划分与组织是模块的实现过程中很关键的步骤，如何划分出合理的函数结构，关系到模块的最终效率和可维护性、可测性等。根据功能图或/及数据流图映射出函数结构是常用方法之一。
  </code>
  </details>
- 改进模块中函数的结构，降低函数间的耦合度，并提高函数的独立性以及代码可读性、效率和可维护性。优化函数结构时，要遵守以下原则。
  >（1）不能影响模块功能的实现。
（2）仔细考查模块或函数出错处理及模块的性能要求并进行完善。
（3）通过分解或合并函数来改进软件结构。
（4）考查函数的规模，过大的要进行分解。
（5）降低函数间接口的复杂度。
（6）函数功能应可预测。
（7）提高函数内聚。（单一功能的函数内聚最高）
说明：对初步划分后的函数结构应进行改进、优化，使之更为合理。

# 文件

- *main.c* 文件中除了 *main( )* 函数外（#include除外），不允许有其他函数、变量的定义（除非是非常非常简单的），保持main.c文件的**简洁**。
- 不要将所有代码函数都写在一个文件中，即使是非常简单的程序。
- 文件的**划分**以**子模块**为单位，较大较复杂的模块可以分割成几个文件，但应保持一定的功能上的独立性。




---
# 注释
[^注释1]: const、static等关键字之后至少要留一个空格，否则无法辨析关键字；if、for、while、switch等关键字之后应留一个空格再跟左括号‘(’，以突出关键字。

[^注释2]: 以免用不同的编辑器阅读程序时，因TAB键所设置的空格数目不同而造成程序布局不整齐。

[^注释3]: 在函数体的开始、类的定义、结构的定义、枚举的定义以及if、for、do、while、switch、case语句中的程序都要采用如上的缩进方式。

[^注释4]: 拆分出的新行要进行适当的缩进，使排版整齐，语句可读。

[^注释5]: 需要为代码中使用的缩写增加注释,文件引入的新缩写必须在文件头部加以说明。

[^注释6]: 建议使用//进行注释，多行注释可使用“/\* …… \*/”。

[^注释7]: 如果你对原始作者的文件做了重大修改, 将你的信息添加到作者信息里。 这样当其他人对该文件有疑问时可以知道该联系谁。

[^注释8]: 要使用全大写的字符串 TODO，后面括号里加上你的大名、邮件地址等，目的是可以根据统一的 TODO 格式进行查找。添加 TODO 注释并不意味着你要自己来修正。

[^注释9]: 例如：Linux、VxWorks、µC/OS-II等等。这种命名清晰易懂，产生歧义的可能性小。函数名应清晰反映函数的功能、用途，见名知意。

